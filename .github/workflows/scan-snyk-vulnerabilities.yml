name: Scan Snyk Vulnerabilities

on:
  schedule:
    # Run daily at 2:00 AM UTC (1 hour before community health collection)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  scan-vulnerabilities:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Snyk CLI
        uses: snyk/actions/setup@master

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Load repository configuration
        id: load-config
        run: |
          # Extract repository list from config.js
          # Parse lines like: { org: 'konveyor', repo: 'analyzer-lsp' },
          grep -A 100 "repositories:" < community-health-dashboard/config.js | \
            grep "org:" | \
            sed "s/.*org: *['\"]\\([^'\"]*\\)['\"].*repo: *['\"]\\([^'\"]*\\)['\"].*/\\1\\/\\2/" > /tmp/repos.txt

          echo "Repositories to scan:"
          < /tmp/repos.txt cat

      - name: Scan repositories with Snyk CLI
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Create output directory
          mkdir -p community-health-dashboard/data/snyk

          # Initialize results JSON
          echo "{\"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"repositories\": []}" > /tmp/snyk-results.json

          # Save the working directory
          WORK_DIR="$(pwd)"

          # Read repositories and scan each one
          while IFS='/' read -r org repo; do
            if [ -z "$org" ] || [ -z "$repo" ]; then
              continue
            fi

            echo "========================================="
            echo "Scanning ${org}/${repo}..."
            echo "========================================="

            # Clone the repository to a temp location
            REPO_DIR="/tmp/scan-${repo}"
            rm -rf "$REPO_DIR"

            if git clone --depth 1 "https://github.com/${org}/${repo}.git" "$REPO_DIR" 2>/dev/null; then
              cd "$REPO_DIR"

              # Install Python dependencies if requirements.txt exists
              # Snyk requires dependencies to be installed in an active venv to scan Python projects
              if find . -name "requirements.txt" -not -path "*/tests/*" -not -path "*/notebooks/*" | grep -q .; then
                echo "  Installing Python dependencies..."
                python3 -m venv .snyk-venv
                source .snyk-venv/bin/activate
                find . -name "requirements.txt" -not -path "*/tests/*" -not -path "*/notebooks/*" | while read reqfile; do
                  echo "    Installing from $reqfile"
                  pip install -q -r "$reqfile" 2>/dev/null || true
                done
              fi

              # Run Snyk dependency test and capture JSON output
              # Use --all-projects to scan all manifest files (package.json, go.mod, pom.xml, requirements.txt, etc.)
              # Use --exclude to skip test directories
              # Use || true to continue even if vulnerabilities are found (which causes non-zero exit)
              echo "  Running dependency scan..."
              # Activate venv if it exists (for Python projects)
              if [ -d .snyk-venv ]; then
                source .snyk-venv/bin/activate
              fi
              snyk test --all-projects --exclude=tests,notebooks --json --org=konveyor > "/tmp/${repo}-deps.json" 2>&1 || true

              # Run Snyk Code test for source code vulnerabilities
              echo "  Running code scan..."
              snyk code test --json --org=konveyor > "/tmp/${repo}-code.json" 2>&1 || true

              # Parse and combine results from both scans
              CRITICAL=0
              HIGH=0
              MEDIUM=0
              LOW=0

              # Parse dependency scan results
              # --all-projects returns an array of project results
              if [ -f "/tmp/${repo}-deps.json" ]; then
                DEPS_CRITICAL=$(jq '[.[] | .vulnerabilities[]? | select(.severity == "critical")] | length' < "/tmp/${repo}-deps.json" 2>/dev/null || echo "0")
                DEPS_HIGH=$(jq '[.[] | .vulnerabilities[]? | select(.severity == "high")] | length' < "/tmp/${repo}-deps.json" 2>/dev/null || echo "0")
                DEPS_MEDIUM=$(jq '[.[] | .vulnerabilities[]? | select(.severity == "medium")] | length' < "/tmp/${repo}-deps.json" 2>/dev/null || echo "0")
                DEPS_LOW=$(jq '[.[] | .vulnerabilities[]? | select(.severity == "low")] | length' < "/tmp/${repo}-deps.json" 2>/dev/null || echo "0")

                CRITICAL=$((CRITICAL + DEPS_CRITICAL))
                HIGH=$((HIGH + DEPS_HIGH))
                MEDIUM=$((MEDIUM + DEPS_MEDIUM))
                LOW=$((LOW + DEPS_LOW))

                echo "    Dependencies: ${DEPS_CRITICAL} critical, ${DEPS_HIGH} high, ${DEPS_MEDIUM} medium, ${DEPS_LOW} low"
              fi

              # Parse code scan results
              if [ -f "/tmp/${repo}-code.json" ]; then
                CODE_CRITICAL=$(jq '[.runs[]?.results[]? | select(.level == "error") | select(.properties.priorityScore >= 700)] | length' < "/tmp/${repo}-code.json" 2>/dev/null || echo "0")
                CODE_HIGH=$(jq '[.runs[]?.results[]? | select(.level == "error") | select(.properties.priorityScore >= 400 and .properties.priorityScore < 700)] | length' < "/tmp/${repo}-code.json" 2>/dev/null || echo "0")
                CODE_MEDIUM=$(jq '[.runs[]?.results[]? | select(.level == "warning")] | length' < "/tmp/${repo}-code.json" 2>/dev/null || echo "0")
                CODE_LOW=$(jq '[.runs[]?.results[]? | select(.level == "note")] | length' < "/tmp/${repo}-code.json" 2>/dev/null || echo "0")

                CRITICAL=$((CRITICAL + CODE_CRITICAL))
                HIGH=$((HIGH + CODE_HIGH))
                MEDIUM=$((MEDIUM + CODE_MEDIUM))
                LOW=$((LOW + CODE_LOW))

                echo "    Code: ${CODE_CRITICAL} critical, ${CODE_HIGH} high, ${CODE_MEDIUM} medium, ${CODE_LOW} low"
              fi

              TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

              if [ $TOTAL -gt 0 ]; then
                echo "  Total: ${CRITICAL} critical, ${HIGH} high, ${MEDIUM} medium, ${LOW} low (${TOTAL} total)"
              else
                echo "  No vulnerabilities found"
              fi

              # Add to results JSON
              jq --arg org "$org" --arg repo "$repo" \
                 --argjson critical "$CRITICAL" --argjson high "$HIGH" \
                 --argjson medium "$MEDIUM" --argjson low "$LOW" --argjson total "$TOTAL" \
                 '.repositories += [{
                   "org": $org,
                   "repo": $repo,
                   "vulnerabilities": {
                     "critical": $critical,
                     "high": $high,
                     "medium": $medium,
                     "low": $low,
                     "total": $total
                   }
                 }]' /tmp/snyk-results.json > /tmp/snyk-results-tmp.json

              mv /tmp/snyk-results-tmp.json /tmp/snyk-results.json

              # Cleanup
              cd /tmp
              rm -rf "$REPO_DIR"
            else
              echo "  âœ— Failed to clone ${org}/${repo}"

              # Add null entry for failed clones
              jq --arg org "$org" --arg repo "$repo" \
                 '.repositories += [{
                   "org": $org,
                   "repo": $repo,
                   "vulnerabilities": null
                 }]' /tmp/snyk-results.json > /tmp/snyk-results-tmp.json

              mv /tmp/snyk-results-tmp.json /tmp/snyk-results.json
            fi

            # Small delay to avoid rate limits
            sleep 2
          done < /tmp/repos.txt

          # Return to working directory and copy final results
          cd "$WORK_DIR"
          cp /tmp/snyk-results.json community-health-dashboard/data/snyk/latest.json

          echo ""
          echo "========================================="
          echo "Scan Summary"
          echo "========================================="
          jq -r '.repositories[] | "\(.org)/\(.repo): \(if .vulnerabilities then "\(.vulnerabilities.total) vulnerabilities" else "N/A" end)"' /tmp/snyk-results.json

      - name: Commit Snyk scan results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add the results file
          git add community-health-dashboard/data/snyk/latest.json

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit with timestamp
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m ":shield: Update Snyk vulnerability scan results - ${DATE}"

          # Push to repository
          git push
